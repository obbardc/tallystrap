#!/usr/bin/env bash
#
# This script will tally up all of your various fruits.
#
# It does not work or do anything interesting. Yet.
#
#
# https://www.youtube.com/watch?v=6Tou8-Cz8is




BUILDENV="`pwd`/tmp"
ROOTSIZE="1500"
IMAGE="$BUILDENV/out.img"
ROOTFS="$BUILDENV/rootfs"

# check root is running
if [ $EUID -ne 0 ]; then
    echo "you must run as root"
    exit 1
fi

# purge old build env
rm -rf $BUILDENV
mkdir -p $BUILDENV

# create blank image $ROOTSIZE blocks long
dd if=/dev/zero of=$IMAGE bs=1MiB count=$ROOTSIZE >& /dev/null
echo "TALLYMAN: created blank image $IMAGE"

# create partition table
# (sunxi needs first 2kb free for bootloader to be installed)
# from 2048 to full card ext4
echo "TALLYMAN: partitioning"
fdisk $IMAGE >& /dev/null << EOF
n
p
1
2048

w
EOF

# create device map
DEVICE=`kpartx -a -v $IMAGE | sed -E 's/.*(loop[0-9])p.*/\1/g' | head -1`
sleep 1
DEVICE="/dev/mapper/${DEVICE}p0"
echo "TALLYMAN: made loop device $DEVICE"

# format
mkfs.ext4 $DEVICE > /dev/null

# mount
mkdir -p $ROOTFS
mount $DEVICE $ROOTFS
cd $ROOTFS

# do evil things to the rootfs here



# stop the doing evil things to the rootfs here

# unmount
umount $DEVICE

# remove the device maps
kpartx -d $DEVICE > /dev/null
echo "TALLYMAN: removed loop device"

# exit
echo "TALLYMAN: completed!"
exit 0